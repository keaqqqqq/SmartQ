@using FNBReservation.Portal.Models
@rendermode InteractiveServer

<MudPaper Elevation="0" Class="pa-4">
    <MudText Typo="Typo.subtitle1" Class="mb-4">Tables Configuration</MudText>

    <MudTable Items="@Tables" Dense="true" Hover="true" Bordered="true" Striped="true">
        <ToolBarContent>
            <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Add"
                       OnClick="OpenTableDialog" Class="ml-auto">Add Table</MudButton>
        </ToolBarContent>
        <HeaderContent>
            <MudTh>Table Number</MudTh>
            <MudTh>Capacity</MudTh>
            <MudTh>Section</MudTh>
            <MudTh>Status</MudTh>
            <MudTh>Actions</MudTh>
        </HeaderContent>
        <RowTemplate>
            <MudTd DataLabel="Table Number">@context.TableNumber</MudTd>
            <MudTd DataLabel="Capacity">@context.Capacity</MudTd>
            <MudTd DataLabel="Section">@context.Section</MudTd>
            <MudTd DataLabel="Status">
                <MudChip Color="@(context.IsActive ? Color.Success : Color.Error)" Size="Size.Small" T="string">
                    @(context.IsActive ? "Active" : "Inactive")
                </MudChip>
            </MudTd>
            <MudTd>
                <MudStack Row="true">
                    <MudIconButton Icon="@Icons.Material.Filled.Edit" Size="Size.Small"
                                   OnClick="@(() => EditTable(context))" />
                    <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" Size="Size.Small"
                                   OnClick="@(() => RemoveTable(context))" />
                </MudStack>
            </MudTd>
        </RowTemplate>
        <NoRecordsContent>
            <MudText Align="Align.Center">No tables added yet. Click the Add Table button to get started.</MudText>
        </NoRecordsContent>
        <PagerContent>
            <MudTablePager />
        </PagerContent>
    </MudTable>

    <MudGrid Class="mt-4">
        <MudItem xs="12">
            <MudPaper Elevation="0" Class="pa-4" Style="background-color: #f5f5f5; border-radius: 4px;">
                <MudText Typo="Typo.subtitle2" Class="mb-2">Quick Add Multiple Tables</MudText>
                <MudGrid>
                    <MudItem xs="3">
                        <MudTextField @bind-Value="bulkSection" Label="Section"
                                      Variant="Variant.Outlined" Placeholder="Main Dining" />
                    </MudItem>
                    <MudItem xs="3">
                        <MudTextField @bind-Value="bulkPrefix" Label="Table # Prefix"
                                      Variant="Variant.Outlined" Placeholder="A" />
                    </MudItem>
                    <MudItem xs="3">
                        <MudNumericField @bind-Value="bulkCount" Label="Number of Tables"
                                         Variant="Variant.Outlined" Min="1" Max="50" />
                    </MudItem>
                    <MudItem xs="3">
                        <MudNumericField @bind-Value="bulkCapacity" Label="Capacity per Table"
                                         Variant="Variant.Outlined" Min="1" Max="20" />
                    </MudItem>
                    <MudItem xs="12">
                        <MudButton Variant="Variant.Filled" Color="Color.Secondary"
                                   OnClick="BulkAddTables" FullWidth="false">
                            Add Tables
                        </MudButton>
                    </MudItem>
                </MudGrid>
            </MudPaper>
        </MudItem>
    </MudGrid>
</MudPaper>

@code {
    [Parameter] public List<TableInfo> Tables { get; set; } = new List<TableInfo>();
    [Parameter] public EventCallback<List<TableInfo>> TablesChanged { get; set; }

    private string bulkSection = "Main Dining";
    private string bulkPrefix = "A";
    private int bulkCount = 5;
    private int bulkCapacity = 4;

    private TableInfo currentTable = new();

    private void OpenTableDialog()
    {
        currentTable = new TableInfo
            {
                TableNumber = $"{bulkPrefix}{Tables.Count + 1}",
                Capacity = 4,
                Section = "Main Dining",
                IsActive = true
            };
        AddOrUpdateTable();
    }

    private void EditTable(TableInfo table)
    {
        currentTable = new TableInfo
            {
                TableNumber = table.TableNumber,
                Capacity = table.Capacity,
                Section = table.Section,
                IsActive = table.IsActive
            };
        RemoveTable(table);
        AddOrUpdateTable();
    }

    private void AddOrUpdateTable()
    {
        Tables.Add(currentTable);
        TablesChanged.InvokeAsync(Tables);
    }

    private void RemoveTable(TableInfo table)
    {
        Tables.Remove(table);
        TablesChanged.InvokeAsync(Tables);
    }

    private void BulkAddTables()
    {
        var startingNumber = Tables.Count + 1;
        for (int i = 0; i < bulkCount; i++)
        {
            Tables.Add(new TableInfo
                {
                    TableNumber = $"{bulkPrefix}{startingNumber + i}",
                    Capacity = bulkCapacity,
                    Section = bulkSection,
                    IsActive = true
                });
        }
        TablesChanged.InvokeAsync(Tables);
    }
}